<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>AR Soplar y Encestar</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
</head>

<body style="margin:0; overflow:hidden;">

<a-scene
  embedded
  arjs="sourceType: webcam; debugUIEnabled: false;"
  vr-mode-ui="enabled:false">

  <!-- MARKER -->
  <a-marker preset="hiro">

    <!-- LUCES -->
    <a-entity light="type: ambient; intensity: 1"></a-entity>
    <a-entity light="type: directional; intensity: 1" position="0 1 1"></a-entity>

    <!-- ARO -->
    <a-torus
      id="hoop"
      position="0 0.6 -1"
      radius="0.3"
      radius-tubular="0.03"
      rotation="90 0 0"
      color="#00FFFF">
    </a-torus>

    <!-- CUBO (VISIBLE SEGURO) -->
    <a-box
      id="cube"
      position="0 0.1 -1"
      depth="0.15"
      height="0.15"
      width="0.15"
      color="#FF3333">
    </a-box>

  </a-marker>

  <a-entity camera></a-entity>
</a-scene>

<!-- UI TAP -->
<div id="tap"
style="
position:fixed;
top:0;left:0;
width:100%;height:100%;
background:#0008;
color:white;
display:flex;
align-items:center;
justify-content:center;
font-size:24px;
z-index:10;">
Toca la pantalla y sopla üå¨Ô∏è
</div>

<script>
let audioContext, analyser;
let velocityY = 0;
const gravity = -0.0012;
const blowForce = 0.004;

const cube = document.querySelector("#cube");
const hoop = document.querySelector("#hoop");

async function initMic() {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const mic = audioContext.createMediaStreamSource(stream);
  analyser = audioContext.createAnalyser();
  analyser.fftSize = 256;
  mic.connect(analyser);
}

function getVolume() {
  const data = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(data);
  return data.reduce((a,b)=>a+b,0) / data.length;
}

function loop() {
  if (!analyser) return;

  const volume = getVolume();
  let pos = cube.getAttribute("position");

  // SOPLAR (umbral alto)
  if (volume > 60) {
    velocityY += blowForce;
  }

  velocityY += gravity;
  pos.y += velocityY;

  // Piso
  if (pos.y < 0.1) {
    pos.y = 0.1;
    velocityY = 0;
  }

  cube.setAttribute("position", pos);

  // CHECK ENCESTAR (estricto)
  const h = hoop.getAttribute("position");
  const dx = Math.abs(pos.x - h.x);
  const dy = pos.y - h.y;
  const dz = Math.abs(pos.z - h.z);

  if (dx < 0.15 && dz < 0.15 && dy > 0 && dy < 0.1) {
    alert("üéâ ENCESTADO!");
    cube.setAttribute("position", {x:0, y:0.1, z:-1});
    velocityY = 0;
  }
}

// TAP para activar mic (iOS)
document.getElementById("tap").addEventListener("click", async () => {
  await initMic();
  document.getElementById("tap").style.display = "none";
  setInterval(loop, 30);
});
</script>

</body>
</html>
