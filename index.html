<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sopla y esquiva ðŸ’¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
html,body{
  margin:0;
  padding:0;
  background:#0b0b0b;
  overflow:hidden;
  touch-action:none;
  font-family: Arial, sans-serif;
}

canvas{
  display:block;
  background: radial-gradient(circle at top, #111, #000);
}

/* BOTONES */
#controls{
  position:fixed;
  bottom:20px;
  width:100%;
  display:flex;
  justify-content:space-between;
  padding:0 30px;
  box-sizing:border-box;
}

.btn{
  width:80px;
  height:80px;
  border-radius:50%;
  background:#ffffff22;
  color:white;
  font-size:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  user-select:none;
}

#start{
  position:fixed;
  inset:0;
  background:#000c;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:24px;
  z-index:10;
  text-align:center;
}
</style>
</head>

<body>

<canvas id="game"></canvas>

<div id="start">Toca para empezar<br>y sopla al micrÃ³fono ðŸ’¨</div>

<div id="controls">
  <div class="btn" id="left">â—€</div>
  <div class="btn" id="right">â–¶</div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* ðŸŽˆ JUGADOR */
let player = {
  x: canvas.width/2,
  y: canvas.height-120,
  r: 18,
  vy: 0
};

const gravity = 0.15;
const blowForce = -0.5;
let moveLeft=false, moveRight=false;

/* ðŸ’£ MINAS */
let mines=[];

function spawnMines(){
  mines=[];
  for(let i=0;i<6;i++){
    mines.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height*0.7,
      r: 18
    });
  }
}

/* ðŸŽ¤ MICRO */
let analyser;

async function initMic(){
  const audio = new AudioContext();
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  const mic = audio.createMediaStreamSource(stream);
  analyser = audio.createAnalyser();
  analyser.fftSize = 256;
  mic.connect(analyser);
}

function getVolume(){
  const data = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(data);
  return data.reduce((a,b)=>a+b)/data.length;
}

/* ðŸŽ® CONTROLES */
document.getElementById("left").ontouchstart=()=>moveLeft=true;
document.getElementById("left").ontouchend=()=>moveLeft=false;
document.getElementById("right").ontouchstart=()=>moveRight=true;
document.getElementById("right").ontouchend=()=>moveRight=false;

/* â–¶ START */
document.getElementById("start").addEventListener("click", async ()=>{
  await initMic();
  spawnMines();
  document.getElementById("start").style.display="none";
  requestAnimationFrame(loop);
});

/* ðŸ”„ LOOP */
function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  let volume = analyser ? getVolume() : 0;

  if(volume > 55){
    player.vy += blowForce;
  }

  player.vy += gravity;
  player.y += player.vy;

  if(moveLeft) player.x -= 4;
  if(moveRight) player.x += 4;

  // lÃ­mites
  player.x = Math.max(player.r, Math.min(canvas.width-player.r, player.x));
  player.y = Math.max(player.r, Math.min(canvas.height-player.r, player.y));

  // dibujar jugador
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.r, 0, Math.PI*2);
  ctx.fillStyle="#00eaff";
  ctx.fill();

  // minas
  for(let m of mines){
    ctx.beginPath();
    ctx.arc(m.x, m.y, m.r, 0, Math.PI*2);
    ctx.fillStyle="crimson";
    ctx.fill();

    let dx = player.x-m.x;
    let dy = player.y-m.y;
    let dist = Math.hypot(dx,dy);

    if(dist < player.r + m.r){
      alert("ðŸ’¥ PERDISTE");
      reset();
      return;
    }
  }

  requestAnimationFrame(loop);
}

function reset(){
  player.x = canvas.width/2;
  player.y = canvas.height-120;
  player.vy = 0;
  spawnMines();
  requestAnimationFrame(loop);
}
</script>

</body>
</html>
